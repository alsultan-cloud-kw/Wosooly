name: FastAPI Deploy (Production)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted]

    defaults:
      run:
        working-directory: ./backend

    steps:
      # 1Ô∏è‚É£ Checkout
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Stop old containers
      - name: Stop old containers
        run: docker compose down -v --remove-orphans

      # 3Ô∏è‚É£ Copy environment file
      - name: Copy environment file
        run: cp /home/harif/envs/wosooly.env .env

      # 4Ô∏è‚É£ Ensure certbot folders exist and correct permissions
      - name: Prepare Certbot folders
        run: |
          sudo mkdir -p /home/harif/certbot/www /home/harif/certbot/conf
          sudo chown -R 1000:1000 /home/harif/certbot
          sudo chmod -R 755 /home/harif/certbot

      # 5Ô∏è‚É£ First-time certificate issuance
      - name: Issue certificate if missing
        run: |
          if [ ! -f /home/harif/certbot/conf/live/api.wosooly.com/fullchain.pem ]; then
            docker compose run --rm wc_solutions_certbot certonly \
              --webroot -w /var/www/certbot \
              -d api.wosooly.com \
              --email your-email@example.com \
              --agree-tos \
              --no-eff-email \
              --non-interactive
          fi

      # 6Ô∏è‚É£ Pull base images
      - name: Pull base images
        run: docker compose pull

      # 7Ô∏è‚É£ Build images
      - name: Build project images
        run: docker compose build

      # 8Ô∏è‚É£ Start containers
      - name: Start containers
        run: docker compose up -d

      # 9Ô∏è‚É£ Wait for DB & Redis
      - name: Wait for services to initialize
        run: sleep 15

      # üîü Test Redis
      - name: Test Redis connectivity
        run: docker compose run --rm wc_solutions_fastapi_app sh -c "python -c 'import os, redis; r = redis.from_url(os.environ[\"REDIS_URL\"]); r.ping(); print(\"‚úÖ Redis OK\")'"

      # 11Ô∏è‚É£ Show running containers
      - name: Show running containers
        run: docker ps



