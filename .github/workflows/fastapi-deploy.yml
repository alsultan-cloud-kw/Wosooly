name: FastAPI Deploy (Production)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted]

    defaults:
      run:
        working-directory: ./backend

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Stop old containers to avoid conflicts
      - name: Stop old containers
        run: docker compose down -v --remove-orphans

      # 3Ô∏è‚É£ Copy environment file from server
      - name: Copy environment file
        run: cp /home/harif/envs/wosooly.env .env

      # 4Ô∏è‚É£ Fix certbot folder permissions (allow write access)
      - name: Fix certbot folder permissions
        run: |
          sudo chown -R 1000:1000 certbot/www certbot/conf
          sudo chmod -R 755 certbot/www certbot/conf

      # 5Ô∏è‚É£ Pull latest base images
      - name: Pull images
        run: docker compose pull

      # 6Ô∏è‚É£ Build project images
      - name: Build images
        run: docker compose build

      # 7Ô∏è‚É£ Start containers
      - name: Start containers
        run: docker compose up -d

      # 8Ô∏è‚É£ Wait a bit to ensure Redis and other dependencies are ready
      - name: Wait for Redis & FastAPI readiness
        run: |
          echo "‚è≥ Waiting for Redis and FastAPI to initialize..."
          sleep 15

      # 9Ô∏è‚É£ Optional: Test Redis connectivity from FastAPI container
      - name: Test Redis connection
        run: docker compose run --rm wc_solutions_fastapi_app sh -c "python -c 'import os, redis; r = redis.from_url(os.environ[\"REDIS_URL\"]); r.ping(); print(\"‚úÖ Redis OK\")'"

      # üîü Verify running containers
      - name: Show running containers
        run: docker ps


